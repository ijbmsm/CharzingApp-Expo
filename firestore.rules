rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // í—¬í¼ í•¨ìˆ˜
    // ============================================

    // ì¸ì¦ëœ ì‚¬ìš©ìì¸ì§€ í™•ì¸
    function isAuthenticated() {
      return request.auth != null;
    }

    // Guest Userì¸ì§€ í™•ì¸ (uidê°€ guest_ë¡œ ì‹œì‘)
    function isGuest() {
      return request.resource.data.uid.matches('guest_.*');
    }

    // íŠ¹ì • ì‚¬ìš©ìì¸ì§€ í™•ì¸
    function isUser(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // ì‚¬ìš©ì role ì¡°íšŒ (ì—†ìœ¼ë©´ 'user'ë¡œ ê°„ì£¼)
    function getUserRole() {
      return isAuthenticated()
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data.get('role', 'user')
        : null;
    }

    // Admin ê¶Œí•œ í™•ì¸
    function isAdmin() {
      return getUserRole() == 'admin';
    }

    // Mechanic ê¶Œí•œ í™•ì¸
    function isMechanic() {
      return getUserRole() == 'mechanic';
    }

    // Admin ë˜ëŠ” Mechanic ê¶Œí•œ í™•ì¸
    function isAdminOrMechanic() {
      return isAdmin() || isMechanic();
    }


    // ============================================
    // 1. users - ì‚¬ìš©ì í”„ë¡œí•„
    // ============================================
    match /users/{userId} {
      // ì½ê¸°: ë³¸ì¸ ë˜ëŠ” Admin
      allow read: if isUser(userId) || isAdmin();

      // ìƒì„±: Guest User (guest_ prefix) ë˜ëŠ” ì¸ì¦ëœ ë³¸ì¸
      // ğŸ”¥ Guest UserëŠ” Cloud Functionsì—ì„œ ìƒì„±ë˜ë¯€ë¡œ ì¸ì¦ ì—†ì´ë„ ìƒì„± ê°€ëŠ¥
      allow create: if isGuest() || isUser(userId);

      // ìˆ˜ì •: ë³¸ì¸ë§Œ (ë‹¨, role ë³€ê²½ ë¶ˆê°€)
      allow update: if isUser(userId)
        && (!request.resource.data.keys().hasAny(['role'])
            || request.resource.data.role == resource.data.get('role', 'user'));

      // ì‚­ì œ: ë³¸ì¸ë§Œ
      allow delete: if isUser(userId);

      // í•˜ìœ„ ì»¬ë ‰ì…˜: inAppNotifications
      match /inAppNotifications/{notificationId} {
        allow read, write: if isUser(userId);
      }

      // í•˜ìœ„ ì»¬ë ‰ì…˜: notificationSettings
      match /notificationSettings/{settingId} {
        allow read, write: if isUser(userId);
      }
    }


    // ============================================
    // 2. vehicles - ì°¨ëŸ‰ ì •ë³´ (ê³µê°œ ë°ì´í„°)
    // ============================================
    match /vehicles/{brandId} {
      // ì½ê¸°: ëª¨ë‘ í—ˆìš© (ê³µê°œ ë°ì´í„°)
      allow read: if true;

      // ì“°ê¸°: Adminë§Œ (ë°ì´í„° ê´€ë¦¬)
      allow write: if isAdmin();

      // í•˜ìœ„ ì»¬ë ‰ì…˜: models
      match /models/{modelId} {
        allow read: if true;
        allow write: if isAdmin();
      }
    }


    // ============================================
    // 3. userVehicles - ì‚¬ìš©ì ì°¨ëŸ‰ ì •ë³´
    // ============================================
    match /userVehicles/{vehicleId} {
      // ì½ê¸°: ì°¨ëŸ‰ ì†Œìœ ì ë˜ëŠ” Admin
      allow read: if isUser(resource.data.userId) || isAdmin();

      // ìƒì„±: ë³¸ì¸ë§Œ (userId ì¼ì¹˜ í•„ìˆ˜)
      allow create: if isAuthenticated()
        && request.resource.data.userId == request.auth.uid;

      // ìˆ˜ì •: ì°¨ëŸ‰ ì†Œìœ ìë§Œ (userId ë³€ê²½ ë¶ˆê°€)
      allow update: if isUser(resource.data.userId)
        && request.resource.data.userId == resource.data.userId;

      // ì‚­ì œ: ì°¨ëŸ‰ ì†Œìœ ìë§Œ
      allow delete: if isUser(resource.data.userId);
    }


    // ============================================
    // 4. diagnosisReservations - ì§„ë‹¨ ì˜ˆì•½
    // ============================================
    match /diagnosisReservations/{reservationId} {
      // ì½ê¸°: ì˜ˆì•½í•œ ë³¸ì¸ ë˜ëŠ” Admin ë˜ëŠ” Mechanic
      // â­ Guest User í¬í•¨: ì¸ì¦ëœ ì‚¬ìš©ìê°€ ìì‹ ì˜ userIdì™€ ì¼ì¹˜í•˜ëŠ” ì˜ˆì•½ì„ ì½ì„ ìˆ˜ ìˆìŒ
      allow read: if (isAuthenticated() && resource.data.userId == request.auth.uid)
        || isAdmin()
        || isMechanic();

      // ìƒì„±: â­ ëˆ„êµ¬ë‚˜ ê°€ëŠ¥ (ì›¹ ë¹„íšŒì› ì˜ˆì•½, Guest User)
      // Cloud Functionsë¥¼ í†µí•œ ìƒì„±ì„ ê¶Œì¥í•˜ì§€ë§Œ, ì§ì ‘ ìƒì„±ë„ í—ˆìš©
      allow create: if true;

      // ìˆ˜ì •: Admin ë˜ëŠ” Mechanic (ì •ë¹„ì‚¬ í• ë‹¹, ìƒíƒœ ë³€ê²½)
      allow update: if isAdmin() || isMechanic();

      // ì‚­ì œ: ì˜ˆì•½í•œ ë³¸ì¸ ë˜ëŠ” Admin
      allow delete: if (isAuthenticated() && resource.data.userId == request.auth.uid)
        || isAdmin();
    }


    // ============================================
    // 5. vehicleDiagnosisReports - ì§„ë‹¨ ë¦¬í¬íŠ¸
    // ============================================
    match /vehicleDiagnosisReports/{reportId} {
      // ì½ê¸°: ë¦¬í¬íŠ¸ ì†Œìœ ì ë˜ëŠ” Admin/Mechanic
      allow read: if isUser(resource.data.userId) || isAdminOrMechanic();

      // ìƒì„±: Admin ë˜ëŠ” Mechanic (ì •ë¹„ì‚¬ê°€ ë¦¬í¬íŠ¸ ì‘ì„±)
      allow create: if isAdminOrMechanic()
        && request.resource.data.status in ['draft', 'pending_review'];

      // ìˆ˜ì •: Admin ë˜ëŠ” Mechanic
      allow update: if isAdminOrMechanic();

      // ì‚­ì œ: Adminë§Œ (Mechanicì€ ì‚­ì œ ë¶ˆê°€)
      allow delete: if isAdmin();
    }


    // ============================================
    // 6. settings - ì•± ì„¤ì • (ì˜ˆì•½ ì‹œê°„ëŒ€ ë“±)
    // ============================================
    match /settings/{settingId} {
      // ì½ê¸°: ëª¨ë‘ í—ˆìš© (ê³µê°œ ì„¤ì •)
      allow read: if true;

      // ì“°ê¸°: Adminë§Œ
      allow write: if isAdmin();
    }


    // ============================================
    // 7. payments - ê²°ì œ ì •ë³´
    // ============================================
    match /payments/{paymentId} {
      // ì½ê¸°: Admin/Mechanic (ê´€ë¦¬ì í˜ì´ì§€ì—ì„œ í™•ì¸) ë˜ëŠ” ê²°ì œí•œ ë³¸ì¸
      allow read: if isAdminOrMechanic()
        || (isAuthenticated() && resource.data.userId == request.auth.uid);

      // ìƒì„±: ëˆ„êµ¬ë‚˜ ê°€ëŠ¥ (Cloud Functionsì—ì„œ ìƒì„±, Guest í¬í•¨)
      allow create: if true;

      // ìˆ˜ì •: Adminë§Œ (í™˜ë¶ˆ ì²˜ë¦¬ ë“±)
      allow update: if isAdmin();

      // ì‚­ì œ: Adminë§Œ
      allow delete: if isAdmin();
    }


    // ============================================
    // 8. coupons - ì¿ í° ì •ë³´
    // ============================================
    match /coupons/{couponId} {
      // ì½ê¸°: ì¿ í° ì†Œìœ ì ë˜ëŠ” Admin
      allow read: if (isAuthenticated() && resource.data.userId == request.auth.uid)
        || isAdmin();

      // ìƒì„±: Adminë§Œ
      allow create: if isAdmin();

      // ìˆ˜ì •: Adminë§Œ
      allow update: if isAdmin();

      // ì‚­ì œ: Adminë§Œ
      allow delete: if isAdmin();
    }


    // ============================================
    // ê¸°íƒ€: ëª…ì‹œë˜ì§€ ì•Šì€ ì»¬ë ‰ì…˜ì€ ëª¨ë‘ ê±°ë¶€
    // ============================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
