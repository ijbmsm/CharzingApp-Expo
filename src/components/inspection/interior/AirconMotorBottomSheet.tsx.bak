import React, { useState, useEffect } from 'react';
import {
  View,
  Text,
  Modal,
  StyleSheet,
  TouchableOpacity,
  ScrollView,
} from 'react-native';
import { SafeAreaView } from 'react-native-safe-area-context';
import { Ionicons } from '@expo/vector-icons';
import { MajorDeviceItem } from '../../../services/firebaseService';
import { colors, commonStyles } from '../../../screens/VehicleInspection/styles/commonStyles';
import { InspectionItem } from '../InspectionItem';

interface AirconMotorBottomSheetProps {
  visible: boolean;
  onClose: () => void;
  onSave: (data: { [key: string]: MajorDeviceItem }) => void;
  initialData: { [key: string]: MajorDeviceItem | undefined };
}

const ITEMS = [
  { key: 'airconStatus', label: '에어컨 작동 상태 및 냄새' },
  { key: 'wiperMotor', label: '와이퍼 모터' },
  { key: 'driverWindowMotor', label: '운전석 윈도우 모터' },
  { key: 'driverRearWindowMotor', label: '운전석 뒷자리 윈도우 모터' },
  { key: 'passengerRearWindowMotor', label: '동승석 뒷자리 윈도우 모터' },
  { key: 'passengerWindowMotor', label: '동승석 윈도우 모터' },
];

export const AirconMotorBottomSheet: React.FC<AirconMotorBottomSheetProps> = ({
  visible,
  onClose,
  onSave,
  initialData,
}) => {
  const [data, setData] = useState<{ [key: string]: MajorDeviceItem }>(
    ITEMS.reduce((acc, item) => {
      acc[item.key] = initialData[item.key] || { name: item.label };
      return acc;
    }, {} as { [key: string]: MajorDeviceItem })
  );

  useEffect(() => {
    if (visible) {
      setData(
        ITEMS.reduce((acc, item) => {
          acc[item.key] = initialData[item.key] || { name: item.label };
          return acc;
        }, {} as { [key: string]: MajorDeviceItem })
      );
    }
  }, [visible, initialData]);

  const handleStatusChange = (key: string, status: 'good' | 'problem') => {
    setData((prev) => ({
      ...prev,
      [key]: {
        name: prev[key]?.name || ITEMS.find(i => i.key === key)?.label || '',
        ...prev[key],
        status,
        issueDescription: status === 'good' ? undefined : prev[key]?.issueDescription,
      },
    }));
  };

  const handleImagePick = (key: string, uri: string) => {
    setData((prev) => ({
      ...prev,
      [key]: {
        name: prev[key]?.name || ITEMS.find(i => i.key === key)?.label || '',
        ...prev[key],
        imageUris: [...(prev[key]?.imageUris || []), ...uris],
      },
    }));
  };

  const handleIssueDescriptionChange = (key: string, description: string) => {
    setData((prev) => ({
      ...prev,
      [key]: {
        name: prev[key]?.name || ITEMS.find(i => i.key === key)?.label || '',
        ...prev[key],
        issueDescription: description,
      },
    }));
  };

  const handleSave = () => {
    onSave(data);
  };

  return (
    <Modal visible={visible} animationType="slide" presentationStyle="pageSheet" onRequestClose={onClose}>
      <SafeAreaView style={commonStyles.modalContainer} edges={['top', 'bottom']}>
        <View style={commonStyles.header}>
          <TouchableOpacity style={commonStyles.closeButton} onPress={onClose}>
            <Ionicons name="close" size={28} color={colors.textPrimary} />
          </TouchableOpacity>
          <Text style={commonStyles.headerTitle}>에어컨 및 모터</Text>
          <TouchableOpacity onPress={handleSave}>
            <Text style={styles.saveButton}>저장</Text>
          </TouchableOpacity>
        </View>

        <ScrollView style={commonStyles.content} contentContainerStyle={commonStyles.scrollContent}>
          {ITEMS.map((item) => {
            const itemData = data[item.key];
            return (
              <InspectionItem
                key={item.key}
                label={item.label}
                status={itemData?.status}
                imageUri={itemData?.imageUri}
                issueDescription={itemData?.issueDescription}
                onStatusChange={(status) => handleStatusChange(item.key, status)}
                onImagePick={(uri) => handleImagePick(item.key, uri)}
                onIssueDescriptionChange={(text) => handleIssueDescriptionChange(item.key, text)}
              />
            );
          })}
        </ScrollView>
      </SafeAreaView>
    </Modal>
  );
};

const styles = StyleSheet.create({
  saveButton: {
    fontSize: 16,
    fontWeight: '600',
    color: colors.secondary,
  },
});
